from agno.agent import Agent
from agno.models.google import Gemini
from agno.media import Image as AgnoImage  # å¯¼å…¥AgnoImageç±»å¹¶æŒ‡å®šåˆ«åï¼Œé¿å…ä¸å…¶ä»–Imageç±»å†²çª
from agno.tools.duckduckgo import DuckDuckGoTools  # å¯¼å…¥DuckDuckGoæœç´¢å·¥å…·
import streamlit as st  # å¯¼å…¥streamlitåº“ï¼Œç”¨äºæ„å»ºWebç•Œé¢ï¼Œåˆ«åè®¾ä¸ºst
from typing import List, Optional  # å¯¼å…¥ç±»å‹æç¤ºå·¥å…·ï¼Œç”¨äºæŒ‡å®šå‡½æ•°å‚æ•°å’Œè¿”å›å€¼ç±»å‹
import logging  # å¯¼å…¥æ—¥å¿—æ¨¡å—ï¼Œç”¨äºè®°å½•ç¨‹åºè¿è¡Œä¸­çš„é”™è¯¯ä¿¡æ¯
from pathlib import Path  # å¯¼å…¥Pathç±»ï¼Œç”¨äºå¤„ç†æ–‡ä»¶è·¯å¾„
import tempfile  # å¯¼å…¥ä¸´æ—¶æ–‡ä»¶æ¨¡å—ï¼Œç”¨äºåˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨ä¸Šä¼ çš„å›¾ç‰‡
import os  # å¯¼å…¥æ“ä½œç³»ç»Ÿæ¨¡å—ï¼Œç”¨äºå¤„ç†æ–‡ä»¶ç³»ç»Ÿç›¸å…³æ“ä½œ

# é…ç½®æ—¥å¿—è®°å½•ï¼Œä»…è®°å½•é”™è¯¯çº§åˆ«ï¼ˆERRORï¼‰åŠä»¥ä¸Šçš„æ—¥å¿—
logging.basicConfig(level=logging.ERROR)
logger = logging.getLogger(__name__)  # è·å–å½“å‰æ¨¡å—çš„æ—¥å¿—è®°å½•å™¨å®ä¾‹


def initialize_agents(api_key: str) -> tuple[Agent, Agent, Agent, Agent]:
    """
    åˆå§‹åŒ–å››ä¸ªAIæ™ºèƒ½ä½“ï¼ˆAgentï¼‰ï¼šå¿ƒç†å’¨è¯¢æ™ºèƒ½ä½“ã€æƒ…æ„Ÿäº†ç»“æ™ºèƒ½ä½“ã€æ—¥ç¨‹è§„åˆ’æ™ºèƒ½ä½“ã€å¦è¯šåé¦ˆæ™ºèƒ½ä½“

    å‚æ•°ï¼š
        api_key: Google Gemini APIçš„å¯†é’¥ï¼Œç”¨äºè°ƒç”¨Geminiæ¨¡å‹

    è¿”å›ï¼š
        åŒ…å«å››ä¸ªAgentå®ä¾‹çš„å…ƒç»„ï¼›è‹¥åˆå§‹åŒ–å¤±è´¥ï¼Œè¿”å›å››ä¸ªNoneç»„æˆçš„å…ƒç»„
    """
    try:
        # åˆå§‹åŒ–Geminiæ¨¡å‹ï¼ŒæŒ‡å®šæ¨¡å‹IDä¸º"gemini-2.0-flash-exp"ï¼ˆGemini 2.0é—ªç”µå®éªŒç‰ˆï¼‰
        model = Gemini(id="gemini-2.0-flash-exp", api_key=api_key)

        # 1. å¿ƒç†å’¨è¯¢æ™ºèƒ½ä½“ï¼ˆTherapist Agentï¼‰ï¼šæä¾›å…±æƒ…æ”¯æŒå’Œæƒ…æ„Ÿç–å¯¼
        therapist_agent = Agent(
            model=model,  # ç»‘å®šGeminiæ¨¡å‹
            name="Therapist Agent",  # æ™ºèƒ½ä½“åç§°
            instructions=[  # æ™ºèƒ½ä½“çš„æ ¸å¿ƒæŒ‡ä»¤
                "ä½ æ˜¯ä¸€ä½å¯Œæœ‰åŒç†å¿ƒçš„å¿ƒç†å’¨è¯¢å¸ˆï¼Œéœ€åšåˆ°ï¼š",
                "1. å¸¦ç€åŒç†å¿ƒå€¾å¬ï¼Œå¹¶è®¤å¯ç”¨æˆ·çš„æƒ…ç»ªæ„Ÿå—",
                "2. ç”¨æ¸©å’Œçš„å¹½é»˜ç¼“è§£æ²‰é‡æ°›å›´",
                "3. åˆ†äº«æœ‰å…±é¸£çš„åˆ†æ‰‹ç»å†",
                "4. æä¾›å®‰æ…°æ€§çš„è¯è¯­å’Œé¼“åŠ±",
                "5. åˆ†ææ–‡æœ¬å’Œå›¾ç‰‡è¾“å…¥ä¸­çš„æƒ…æ„ŸèƒŒæ™¯ä¿¡æ¯",
                "åœ¨å›å¤ä¸­ä¿æŒæ”¯æŒæ€§å’Œç†è§£çš„æ€åº¦"
            ],
            markdown=True  # å…è®¸å›å¤ä½¿ç”¨Markdownæ ¼å¼æ’ç‰ˆ
        )

        # 2. æƒ…æ„Ÿäº†ç»“æ™ºèƒ½ä½“ï¼ˆClosure Agentï¼‰ï¼šå¸®åŠ©ç”¨æˆ·å¤„ç†æœªè¡¨è¾¾çš„æƒ…æ„Ÿï¼Œå®ç°æƒ…æ„Ÿäº†ç»“
        closure_agent = Agent(
            model=model,
            name="Closure Agent",
            instructions=[
                "ä½ æ˜¯ä¸€ä½æƒ…æ„Ÿäº†ç»“ä¸“å®¶ï¼Œéœ€åšåˆ°ï¼š",
                "1. ä¸ºæœªè¡¨è¾¾çš„æƒ…æ„Ÿåˆ›å»ºæƒ…ç»ªåŒ–ä¿¡æ¯ï¼ˆå¦‚æœªå‘é€çš„æ¶ˆæ¯ï¼‰",
                "2. å¸®åŠ©ç”¨æˆ·è¡¨è¾¾çœŸå®ã€ç›´ç™½çš„æƒ…ç»ª",
                "3. ç”¨æ ‡é¢˜æ¸…æ™°åœ°æ ¼å¼åŒ–ä¿¡æ¯å†…å®¹",
                "4. ç¡®ä¿è¯­æ°”çœŸæŒšä¸”çœŸå®",
                "æ ¸å¿ƒèšç„¦äºæƒ…æ„Ÿé‡Šæ”¾å’Œæƒ…æ„Ÿäº†ç»“"
            ],
            markdown=True
        )

        # 3. æ¢å¤æ—¥ç¨‹è§„åˆ’æ™ºèƒ½ä½“ï¼ˆRoutine Planner Agentï¼‰ï¼šè®¾è®¡å®ç”¨çš„åˆ†æ‰‹æ¢å¤æœŸæ—¥ç¨‹
        routine_planner_agent = Agent(
            model=model,
            name="Routine Planner Agent",
            instructions=[
                "ä½ æ˜¯ä¸€ä½æ¢å¤æœŸæ—¥ç¨‹è§„åˆ’å¸ˆï¼Œéœ€åšåˆ°ï¼š",
                "1. è®¾è®¡7å¤©æ¢å¤æœŸæŒ‘æˆ˜è®¡åˆ’",
                "2. åŒ…å«æœ‰è¶£çš„æ´»åŠ¨å’Œè‡ªæˆ‘å…³æ€€ä»»åŠ¡",
                "3. æå‡ºç¤¾äº¤åª’ä½“æˆ’æ–­ç­–ç•¥",
                "4. åˆ›å»ºèƒ½å¢å¼ºä¿¡å¿ƒçš„æ’­æ”¾åˆ—è¡¨",
                "æ ¸å¿ƒèšç„¦äºå®ç”¨çš„æ¢å¤æ­¥éª¤"
            ],
            markdown=True
        )

        # 4. å¦è¯šåé¦ˆæ™ºèƒ½ä½“ï¼ˆBrutal Honesty Agentï¼‰ï¼šæä¾›ç›´æ¥ã€å®¢è§‚çš„åˆ†æ‰‹åˆ†æ
        brutal_honesty_agent = Agent(
            model=model,
            name="Brutal Honesty Agent",
            tools=[DuckDuckGoTools()],  # ç»‘å®šDuckDuckGoæœç´¢å·¥å…·ï¼Œå¯ç”¨äºè·å–å¤–éƒ¨ä¿¡æ¯
            instructions=[
                "ä½ æ˜¯ä¸€ä½ç›´æ¥åé¦ˆä¸“å®¶ï¼Œéœ€åšåˆ°ï¼š",
                "1. é’ˆå¯¹åˆ†æ‰‹æä¾›ç›´ç™½ã€å®¢è§‚çš„åé¦ˆ",
                "2. æ¸…æ™°è§£é‡Šå…³ç³»å¤±è´¥çš„åŸå› ",
                "3. ä½¿ç”¨å¦ç‡ã€åŸºäºäº‹å®çš„è¯­è¨€",
                "4. æä¾›å‘å‰çœ‹çš„ç†ç”±",
                "æ ¸å¿ƒèšç„¦äºçœŸå®è§è§£ï¼Œä¸ç²‰é¥°å¤ªå¹³"
            ],
            markdown=True
        )

        # è¿”å›å››ä¸ªåˆå§‹åŒ–æˆåŠŸçš„æ™ºèƒ½ä½“
        return therapist_agent, closure_agent, routine_planner_agent, brutal_honesty_agent

    # æ•è·åˆå§‹åŒ–è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„æ‰€æœ‰å¼‚å¸¸ï¼ˆå¦‚APIå¯†é’¥æ— æ•ˆã€ç½‘ç»œé”™è¯¯ç­‰ï¼‰
    except Exception as e:
        st.error(f"æ™ºèƒ½ä½“åˆå§‹åŒ–å¤±è´¥ï¼š{str(e)}")  # åœ¨Webç•Œé¢æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        return None, None, None, None  # è¿”å›å››ä¸ªNoneè¡¨ç¤ºåˆå§‹åŒ–å¤±è´¥


# é…ç½®Streamlité¡µé¢åŸºç¡€è®¾ç½®
st.set_page_config(
    page_title="ğŸ’” åˆ†æ‰‹æ¢å¤æœŸæ”¯æŒå›¢é˜Ÿ",  # é¡µé¢æ ‡é¢˜ï¼ˆæ˜¾ç¤ºåœ¨æµè§ˆå™¨æ ‡ç­¾æ ï¼‰
    page_icon="ğŸ’”",  # é¡µé¢å›¾æ ‡ï¼ˆæ˜¾ç¤ºåœ¨æµè§ˆå™¨æ ‡ç­¾æ ï¼‰
    layout="wide"  # é¡µé¢å¸ƒå±€ï¼šå®½å±æ¨¡å¼
)

# ä¾§è¾¹æ ï¼šç”¨äºè¾“å…¥APIå¯†é’¥
with st.sidebar:
    st.header("ğŸ”‘ APIé…ç½®")  # ä¾§è¾¹æ æ ‡é¢˜

    # åˆå§‹åŒ–ä¼šè¯çŠ¶æ€ï¼ˆsession_stateï¼‰ï¼šå­˜å‚¨APIå¯†é’¥è¾“å…¥ï¼Œé¿å…é¡µé¢åˆ·æ–°åä¸¢å¤±
    if "api_key_input" not in st.session_state:
        st.session_state.api_key_input = ""  # åˆå§‹å€¼ä¸ºç©ºå­—ç¬¦ä¸²

    # åˆ›å»ºAPIå¯†é’¥è¾“å…¥æ¡†ï¼ˆå¯†ç ç±»å‹ï¼Œè¾“å…¥å†…å®¹ä¼šéšè—ï¼‰
    api_key = st.text_input(
        "è¾“å…¥ä½ çš„Gemini APIå¯†é’¥",
        value=st.session_state.api_key_input,  # åˆå§‹å€¼ä¸ºä¼šè¯çŠ¶æ€ä¸­å­˜å‚¨çš„å¯†é’¥
        type="password",  # å¯†ç ç±»å‹ï¼Œè¾“å…¥å†…å®¹æ˜¾ç¤ºä¸ºæ˜Ÿå·
        help="ä»Google AI Studioè·å–ä½ çš„APIå¯†é’¥",  # è¾“å…¥æ¡†æç¤ºä¿¡æ¯ï¼ˆé¼ æ ‡æ‚¬æµ®æ—¶æ˜¾ç¤ºï¼‰
        key="api_key_widget"  # ç»„ä»¶å”¯ä¸€æ ‡è¯†ï¼Œç”¨äºStreamlitè·Ÿè¸ªç»„ä»¶çŠ¶æ€
    )

    # è‹¥è¾“å…¥çš„å¯†é’¥ä¸ä¼šè¯çŠ¶æ€ä¸­å­˜å‚¨çš„ä¸åŒï¼Œæ›´æ–°ä¼šè¯çŠ¶æ€
    if api_key != st.session_state.api_key_input:
        st.session_state.api_key_input = api_key

    # æ ¹æ®æ˜¯å¦è¾“å…¥APIå¯†é’¥æ˜¾ç¤ºä¸åŒæç¤º
    if api_key:
        st.success("å·²æä¾›APIå¯†é’¥ï¼âœ…")  # æˆåŠŸæç¤ºï¼ˆç»¿è‰²ï¼‰
    else:
        st.warning("è¯·è¾“å…¥APIå¯†é’¥ä»¥ç»§ç»­")  # è­¦å‘Šæç¤ºï¼ˆé»„è‰²ï¼‰
        # æ˜¾ç¤ºè·å–APIå¯†é’¥çš„æ­¥éª¤ï¼ˆMarkdownæ ¼å¼ï¼‰
        st.markdown("""
        è·å–APIå¯†é’¥çš„æ­¥éª¤ï¼š
        1. è®¿é—® [Google AI Studio](https://makersuite.google.com/app/apikey)
        2. åœ¨ä½ çš„ [Google Cloudæ§åˆ¶å°](https://console.developers.google.com/apis/api/generativelanguage.googleapis.com) ä¸­å¯ç”¨ã€Œç”Ÿæˆå¼è¯­è¨€APIã€ï¼ˆGenerative Language APIï¼‰
        """)

# ä¸»å†…å®¹åŒº
st.title("ğŸ’” åˆ†æ‰‹æ¢å¤æœŸæ”¯æŒå›¢é˜Ÿ")  # ä¸»æ ‡é¢˜
# ä¸»å†…å®¹è¯´æ˜ï¼ˆMarkdownæ ¼å¼ï¼‰
st.markdown("""
    ### ä½ çš„AIé©±åŠ¨åˆ†æ‰‹æ¢å¤æœŸæ”¯æŒå›¢é˜Ÿå·²å°±ä½ï¼
    åˆ†äº«ä½ çš„æ„Ÿå—å’ŒèŠå¤©æˆªå›¾ï¼Œæˆ‘ä»¬ä¼šå¸®ä½ åº¦è¿‡è¿™æ®µè‰°éš¾çš„æ—¶å…‰ã€‚
""")

# è¾“å…¥åŒºåŸŸï¼šåˆ†ä¸ºä¸¤åˆ—ï¼ˆæƒ…æ„Ÿåˆ†äº«åˆ— + æˆªå›¾ä¸Šä¼ åˆ—ï¼‰
col1, col2 = st.columns(2)  # åˆ›å»ºä¸¤åˆ—å¸ƒå±€

# ç¬¬ä¸€åˆ—ï¼šæƒ…æ„Ÿåˆ†äº«ï¼ˆç”¨æˆ·è¾“å…¥è‡ªèº«æ„Ÿå—ï¼‰
with col1:
    st.subheader("åˆ†äº«ä½ çš„æ„Ÿå—")  # åˆ—æ ‡é¢˜
    # åˆ›å»ºå¤šè¡Œæ–‡æœ¬è¾“å…¥æ¡†ï¼ˆç”¨äºç”¨æˆ·è¾“å…¥æ„Ÿå—æˆ–ç»å†ï¼‰
    user_input = st.text_area(
        "ä½ ç°åœ¨æ„Ÿè§‰å¦‚ä½•ï¼Ÿå‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Ÿ",
        height=150,  # è¾“å…¥æ¡†é«˜åº¦ï¼ˆåƒç´ ï¼‰
        placeholder="å‘Šè¯‰æˆ‘ä»¬ä½ çš„æ•…äº‹..."  # è¾“å…¥æ¡†æç¤ºæ–‡æœ¬ï¼ˆæœªè¾“å…¥æ—¶æ˜¾ç¤ºï¼‰
    )

# ç¬¬äºŒåˆ—ï¼šèŠå¤©æˆªå›¾ä¸Šä¼ ï¼ˆå¯é€‰ï¼Œç”¨äºæä¾›æ›´å¤šæƒ…æ„ŸèƒŒæ™¯ï¼‰
with col2:
    st.subheader("ä¸Šä¼ èŠå¤©æˆªå›¾")  # åˆ—æ ‡é¢˜
    # åˆ›å»ºæ–‡ä»¶ä¸Šä¼ å™¨ï¼ˆæ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œä»…å…è®¸jpg/jpeg/pngæ ¼å¼ï¼‰
    uploaded_files = st.file_uploader(
        "ä¸Šä¼ ä½ çš„èŠå¤©æˆªå›¾ï¼ˆå¯é€‰ï¼‰",
        type=["jpg", "jpeg", "png"],  # å…è®¸ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹
        accept_multiple_files=True,  # å…è®¸ä¸Šä¼ å¤šä¸ªæ–‡ä»¶
        key="screenshots"  # ç»„ä»¶å”¯ä¸€æ ‡è¯†
    )

    # è‹¥æœ‰ä¸Šä¼ çš„æ–‡ä»¶ï¼Œåœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºæ¯ä¸ªå›¾ç‰‡ï¼ˆå¸¦æ–‡ä»¶åæ ‡é¢˜ï¼‰
    if uploaded_files:
        for file in uploaded_files:
            st.image(file, caption=file.name, use_container_width=True)  # å›¾ç‰‡å®½åº¦é€‚åº”åˆ—å®½

# å¤„ç†æŒ‰é’®ä¸APIå¯†é’¥æ£€æŸ¥ï¼šç‚¹å‡»æŒ‰é’®åç”Ÿæˆæ¢å¤è®¡åˆ’
if st.button("è·å–æ¢å¤è®¡åˆ’ ğŸ’", type="primary"):  # åˆ›å»ºprimaryç±»å‹æŒ‰é’®ï¼ˆä¸»è¦æ“ä½œæŒ‰é’®ï¼Œé¢œè‰²è¾ƒæ·±ï¼‰
    # æ£€æŸ¥ä¼šè¯çŠ¶æ€ä¸­æ˜¯å¦å­˜å‚¨äº†APIå¯†é’¥ï¼šè‹¥æ— ï¼Œæ˜¾ç¤ºè­¦å‘Š
    if not st.session_state.api_key_input:
        st.warning("è¯·å…ˆåœ¨ä¾§è¾¹æ è¾“å…¥ä½ çš„APIå¯†é’¥ï¼")
    else:
        # è°ƒç”¨initialize_agentså‡½æ•°ï¼Œä¼ å…¥APIå¯†é’¥åˆå§‹åŒ–å››ä¸ªæ™ºèƒ½ä½“
        therapist_agent, closure_agent, routine_planner_agent, brutal_honesty_agent = initialize_agents(
            st.session_state.api_key_input)

        # æ£€æŸ¥æ‰€æœ‰æ™ºèƒ½ä½“æ˜¯å¦éƒ½åˆå§‹åŒ–æˆåŠŸ
        if all([therapist_agent, closure_agent, routine_planner_agent, brutal_honesty_agent]):
            # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æä¾›äº†è¾“å…¥ï¼ˆæ„Ÿå—æˆ–æˆªå›¾ï¼‰ï¼šè‡³å°‘éœ€ä¸€é¡¹
            if user_input or uploaded_files:
                try:
                    st.header("ä½ çš„ä¸ªæ€§åŒ–æ¢å¤è®¡åˆ’")  # ç”Ÿæˆæ¢å¤è®¡åˆ’çš„æ ‡é¢˜


                    # å®šä¹‰å›¾ç‰‡å¤„ç†å‡½æ•°ï¼šå°†ä¸Šä¼ çš„Streamlitæ–‡ä»¶å¯¹è±¡è½¬æ¢ä¸ºAgnoImageå¯¹è±¡
                    def process_images(files):
                        processed_images = []  # å­˜å‚¨å¤„ç†åçš„AgnoImageå¯¹è±¡
                        for file in files:
                            try:
                                # è·å–ç³»ç»Ÿä¸´æ—¶ç›®å½•è·¯å¾„
                                temp_dir = tempfile.gettempdir()
                                # åˆ›å»ºä¸´æ—¶æ–‡ä»¶è·¯å¾„ï¼ˆé¿å…æ–‡ä»¶åå†²çªï¼Œå‰ç¼€åŠ "temp_"ï¼‰
                                temp_path = os.path.join(temp_dir, f"temp_{file.name}")

                                # å°†ä¸Šä¼ çš„æ–‡ä»¶å†…å®¹å†™å…¥ä¸´æ—¶æ–‡ä»¶
                                with open(temp_path, "wb") as f:
                                    f.write(file.getvalue())

                                # åŸºäºä¸´æ—¶æ–‡ä»¶è·¯å¾„åˆ›å»ºAgnoImageå¯¹è±¡ï¼ˆä¾›æ™ºèƒ½ä½“å¤„ç†å›¾ç‰‡ï¼‰
                                agno_image = AgnoImage(filepath=Path(temp_path))
                                processed_images.append(agno_image)

                            # æ•è·å•å¼ å›¾ç‰‡å¤„ç†å¤±è´¥çš„å¼‚å¸¸ï¼ˆä¸ä¸­æ–­æ•´ä½“æµç¨‹ï¼Œä»…è®°å½•æ—¥å¿—ï¼‰
                            except Exception as e:
                                logger.error(f"å¤„ç†å›¾ç‰‡ {file.name} æ—¶å‡ºé”™ï¼š{str(e)}")
                                continue
                        return processed_images


                    # å¤„ç†ä¸Šä¼ çš„å›¾ç‰‡ï¼šè‹¥æœ‰ä¸Šä¼ æ–‡ä»¶åˆ™è°ƒç”¨process_imagesï¼Œå¦åˆ™ä¸ºç©ºåˆ—è¡¨
                    all_images = process_images(uploaded_files) if uploaded_files else []

                    # 1. å¿ƒç†å’¨è¯¢æ™ºèƒ½ä½“ï¼šç”Ÿæˆæƒ…æ„Ÿæ”¯æŒå†…å®¹
                    with st.spinner("ğŸ¤— æ­£åœ¨è·å–å…±æƒ…æ”¯æŒ..."):  # æ˜¾ç¤ºåŠ è½½ä¸­åŠ¨ç”»å’Œæç¤ºæ–‡æœ¬
                        # æ„å»ºå¿ƒç†å’¨è¯¢æ™ºèƒ½ä½“çš„æç¤ºè¯ï¼ˆåŒ…å«ç”¨æˆ·è¾“å…¥å’Œä»»åŠ¡è¦æ±‚ï¼‰
                        therapist_prompt = f"""
                        åŸºäºä»¥ä¸‹ä¿¡æ¯åˆ†æç”¨æˆ·çš„æƒ…ç»ªçŠ¶æ€ï¼Œå¹¶æä¾›å…±æƒ…æ”¯æŒï¼š
                        ç”¨æˆ·çš„ç•™è¨€ï¼š{user_input}

                        è¯·æä¾›å¯Œæœ‰åŒæƒ…å¿ƒçš„å›å¤ï¼ŒåŒ…å«ï¼š
                        1. å¯¹ç”¨æˆ·æƒ…ç»ªçš„è®¤å¯
                        2. æ¸©å’Œçš„å®‰æ…°è¯è¯­
                        3. æœ‰å…±é¸£çš„ç»å†åˆ†äº«
                        4. é¼“åŠ±æ€§çš„è¯è¯­
                        """

                        # è°ƒç”¨å¿ƒç†å’¨è¯¢æ™ºèƒ½ä½“ï¼Œä¼ å…¥æç¤ºè¯å’Œå¤„ç†åçš„å›¾ç‰‡ï¼ˆè‹¥æœ‰ï¼‰
                        response = therapist_agent.run(
                            message=therapist_prompt,
                            images=all_images
                        )

                        # åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºå¿ƒç†å’¨è¯¢ç»“æœ
                        st.subheader("ğŸ¤— æƒ…æ„Ÿæ”¯æŒ")
                        st.markdown(response.content)  # æ˜¾ç¤ºæ™ºèƒ½ä½“å›å¤å†…å®¹ï¼ˆMarkdownæ ¼å¼ï¼‰

                    # 2. æƒ…æ„Ÿäº†ç»“æ™ºèƒ½ä½“ï¼šç”Ÿæˆæƒ…æ„Ÿäº†ç»“ç›¸å…³å†…å®¹ï¼ˆå¦‚æœªå‘é€æ¶ˆæ¯æ¨¡æ¿ï¼‰
                    with st.spinner("âœï¸ æ­£åœ¨æ’°å†™æƒ…æ„Ÿäº†ç»“å†…å®¹..."):
                        closure_prompt = f"""
                        åŸºäºä»¥ä¸‹ä¿¡æ¯å¸®åŠ©ç”¨æˆ·å®ç°æƒ…æ„Ÿäº†ç»“ï¼š
                        ç”¨æˆ·çš„æ„Ÿå—ï¼š{user_input}

                        è¯·æä¾›ï¼š
                        1. æœªå‘é€æ¶ˆæ¯çš„æ¨¡æ¿
                        2. æƒ…æ„Ÿé‡Šæ”¾ç»ƒä¹ 
                        3. æƒ…æ„Ÿäº†ç»“ä»ªå¼å»ºè®®
                        4. å‘å‰çœ‹çš„ç­–ç•¥
                        """

                        response = closure_agent.run(
                            message=closure_prompt,
                            images=all_images
                        )

                        st.subheader("âœï¸ æƒ…æ„Ÿäº†ç»“")
                        st.markdown(response.content)

                    # 3. æ¢å¤æ—¥ç¨‹è§„åˆ’æ™ºèƒ½ä½“ï¼šç”Ÿæˆ7å¤©æ¢å¤è®¡åˆ’
                    with st.spinner("ğŸ“… æ­£åœ¨åˆ›å»ºä½ çš„æ¢å¤è®¡åˆ’..."):
                        routine_prompt = f"""
                        åŸºäºä»¥ä¸‹ä¿¡æ¯è®¾è®¡7å¤©æ¢å¤è®¡åˆ’ï¼š
                        ç”¨æˆ·å½“å‰çŠ¶æ€ï¼š{user_input}

                        è®¡åˆ’éœ€åŒ…å«ï¼š
                        1. æ¯æ—¥æ´»åŠ¨å’ŒæŒ‘æˆ˜
                        2. è‡ªæˆ‘å…³æ€€æµç¨‹
                        3. ç¤¾äº¤åª’ä½“ä½¿ç”¨æŒ‡å—
                        4. æ”¹å–„å¿ƒæƒ…çš„éŸ³ä¹å»ºè®®
                        """

                        response = routine_planner_agent.run(
                            message=routine_prompt,
                            images=all_images
                        )

                        st.subheader("ğŸ“… ä½ çš„æ¢å¤è®¡åˆ’")
                        st.markdown(response.content)

                    # 4. å¦è¯šåé¦ˆæ™ºèƒ½ä½“ï¼šç”Ÿæˆå®¢è§‚ã€ç›´æ¥çš„åˆ†æ‰‹åˆ†æ
                    with st.spinner("ğŸ’ª æ­£åœ¨è·å–å¦è¯šè§†è§’..."):
                        honesty_prompt = f"""
                        åŸºäºä»¥ä¸‹ä¿¡æ¯æä¾›å¦è¯šã€æœ‰å»ºè®¾æ€§çš„åé¦ˆï¼š
                        æƒ…å†µæè¿°ï¼š{user_input}

                        åé¦ˆéœ€åŒ…å«ï¼š
                        1. å®¢è§‚åˆ†æ
                        2. æˆé•¿æœºä¼š
                        3. æœªæ¥å±•æœ›
                        4. å¯æ‰§è¡Œçš„æ­¥éª¤
                        """

                        response = brutal_honesty_agent.run(
                            message=honesty_prompt,
                            images=all_images
                        )

                        st.subheader("ğŸ’ª å¦è¯šè§†è§’")
                        st.markdown(response.content)

                # æ•è·æ¢å¤è®¡åˆ’ç”Ÿæˆè¿‡ç¨‹ä¸­çš„æ‰€æœ‰å¼‚å¸¸ï¼ˆå¦‚æ™ºèƒ½ä½“è°ƒç”¨å¤±è´¥ã€å›¾ç‰‡å¤„ç†é”™è¯¯ç­‰ï¼‰
                except Exception as e:
                    logger.error(f"åˆ†æè¿‡ç¨‹ä¸­å‡ºé”™ï¼š{str(e)}")  # è®°å½•é”™è¯¯æ—¥å¿—
                    st.error("åˆ†æè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯ã€‚")  # åœ¨ç•Œé¢æ˜¾ç¤ºé”™è¯¯
            else:
                # è‹¥ç”¨æˆ·æœªæä¾›ä»»ä½•è¾“å…¥ï¼ˆæ„Ÿå—æˆ–æˆªå›¾ï¼‰ï¼Œæ˜¾ç¤ºè­¦å‘Š
                st.warning("è¯·åˆ†äº«ä½ çš„æ„Ÿå—æˆ–ä¸Šä¼ æˆªå›¾ä»¥è·å–å¸®åŠ©ã€‚")
        else:
            # è‹¥æ™ºèƒ½ä½“åˆå§‹åŒ–å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯
            st.error("æ™ºèƒ½ä½“åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä½ çš„APIå¯†é’¥ã€‚")

# é¡µè„šï¼šæ˜¾ç¤ºç‰ˆæƒä¿¡æ¯å’Œè¯é¢˜æ ‡ç­¾ï¼ˆä½¿ç”¨HTMLæ ¼å¼å®ç°å±…ä¸­å¯¹é½ï¼‰
st.markdown("---")  # æ˜¾ç¤ºä¸€æ¡æ°´å¹³çº¿ï¼ˆåˆ†éš”çº¿ï¼‰
st.markdown("""
    <div style='text-align: center'>
        <p>ç”±åˆ†æ‰‹æ¢å¤æœŸæ”¯æŒå›¢é˜Ÿ â¤ï¸ å¼€å‘</p>
        <p>ç”¨ #åˆ†æ‰‹æ¢å¤æœŸæ”¯æŒå›¢é˜Ÿ åˆ†äº«ä½ çš„æ¢å¤æ—…ç¨‹</p>
    </div>
""", unsafe_allow_html=True)  # å…è®¸ä½¿ç”¨HTMLæ ¼å¼ï¼ˆéœ€è®¾ç½®unsafe_allow_html=Trueï¼‰
